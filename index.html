<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>HTML5 Barrage Player</title>
	<link rel="stylesheet" href="style/style.css">
</head>

<body>
	<header>
		<h3>HTML5 Barrage Player</h3>
	</header>

	<div class="container">
		<div class="container-left">
			<video id="video-main" src="ly.mp4" type="video/mp4" controls>
				Your browser dosen't support HTML5 Video
			</video>
			<div class="container-bottom">
				<div class="video-bottom-left">输入弹幕:</div>
				<input type="text" placeholder="蛤蛤蛤蛤蛤蛤蛤蛤" />
				<input type="button" value="发送">
			</div>
			<div class="barrage" id="hhh1">哈哈哈哈哈哈哈hhhhhhh哈哈</div>
		</div>
		<div class="container-right">
			<div class="right-top">
				<div class="right-top-left">
					<span>弹幕:233</span>
					<br/><span>观众:23333</span>
					<br/><span>播放:233</span>
				</div>
				<div class="right-top-right">
					<span>预留地</span>
				</div>
			</div>
			<div class="right-bottom">
				<div class="right-bottom-top">
					<ul>
						<li id="video-time">时间</li>
						<li id="comment">评论</li>
						<li id="send-time">发送时间</li>
					</ul>
				</div>
				<div class="right-bottom-list">ffddf</div>
			</div>
		</div>
	</div>

	<footer>
		<h5><span>Powered by <a href="http://ivydom.com" target="_blank">ivydom.com</a></span></h5>
	</footer>

	<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){

      		//添加动画效果
      		$('h3,h5 span,.right-bottom-top ul li,input').hover(
        		function(){$(this).stop().animate({opacity:0.6},400);},
        		function(){$(this).stop().animate({opacity:1},400);}
      		);

      		//弹幕池
      		var barragesPool=
      		{
      			'total':2,
      			'0.0':
      			{
      				'total':2,
      				1:{'content':"fuck",'time':'2015-02-16 20:00:00'},
      				2:{'content':"shit",'time':'2015-02-16 20:20:00'}
      			}
      		};

      		//弹幕池的构造函数,b代表弹幕池数组
      		function BarragePool(b){
      			this.bp=b;
      			this.bp['total']=0;
      		}

      		//增加弹幕
      		//vTime为视频时间轴,一般为0.1,0.2,0.3....
      		//content为弹幕内容
      		//time为弹幕发送时间
      		BarragePool.prototype.add=function(vTime,content,time){
      			//判断时间轴vTime上是否有弹幕
      			var isVTime=this.bp.hasOwnProperty(vTime);

      			//如果vTime存在,则直接获得时间轴下的弹幕数量并往上加1,否则初始化时间轴数组并且设置total为1
      			if(isVTime){
      				//获得vTime时间轴下的弹幕数量
      				var total=this.bp[vTime]['total'];
      				this.bp[vTime]['total']+=+1;
      				total+=1;
      			}else{
      				this.bp[vTime]={};
      				this.bp[vTime]['total']=1;
      				total=1;
      			}

      			//弹幕总数加1
      			this.bp['total']+=1;

      			//将弹幕加到bp数组中
      			this.bp[vTime][total]={'content':content,'time':time};
      		}

      		//删除弹幕
      		//如果index为空但vTime不为空则删除vTime下所有弹幕
      		//如果index不为空且vTime不为空,则删除vTime下key为index的弹幕
      		BarragePool.prototype.del=function(vTime,index){
      			var indexB=index || null;
      			//如果vTime为空,则返回,什么也不作
      			if(vTime=='undefined'){return;}

      			//如果没有vTime则返回
      			var isVTime=this.bp.hasOwnProperty(vTime);
      			if(!isVTime){return;}

      			//获得总弹幕数量,如果为0则返回什么都不做
      			var totalBarrage=this.bp['total'];
      			if(totalBarrage===0){return;}

      			//如果index为空
      			if(indexB==null){
      				//先获得vTime下的弹幕数量
      				var totalVAmount=this.bp[vTime]['total'];
      				this.bp[vTime]=[];

      				//重置总弹幕数量为当前数量减去删除的弹幕数量->totalVAmount
      				this.bp['total']-=totalVAmount;
      			}else{
      				//如果index不为空
      				this.bp[vTime][index]=[];
      				this.bp['total']-=1;
      				this.bp[vTime]['total']-=1;
      			}
      		}

      		//得到某时间轴的弹幕
      		//vTime为视频时间轴,index为vTime下的弹幕索引
      		//如果vTime为空则直接返回
      		//如果index为空则返回vTime下所有弹幕,如果index不为空则返回vTime下第index个弹幕
      		BarragePool.prototype.get=function(vTime,index){
      			if(vTime==null){return;}

      			//如果没有vTime则返回
      			var isVTime=this.bp.hasOwnProperty(vTime);
      			if(!isVTime){return;}

      			//获得总弹幕数量,如果为0则返回什么都不做
      			var totalBarrage=this.bp['total'];
      			if(totalBarrage===0){return;}

      			if(index==null){
      				return this.bp[vTime];
      			}else{
      				//先获得vTime下弹幕总数量
      				var vTimeTotal=this.bp[vTime]['total'];
      				//如果index大于vTimeTotal或者小于0则直接返回
      				if(index>vTimeTotal || index<0){return;}
      				return this.bp[vTime][index];
      			}
      		}


      		var BP=new BarragePool(barragesPool);

      		BP.add('0.1',"fuckbitch","2012");
      		BP.add('0.1',"hhhhhhhhhhh","2013");
      		BP.add('0.2','hahahahahahaha','2015');

      		console.log(barragesPool['total']);
      		console.log(barragesPool['0.1']['total']);
      		console.log(barragesPool['0.1'][2]);
      		console.log(barragesPool['0.2'][1]);

      		BP.del('0.2');
      		console.log('删除0.2之后:',barragesPool['0.2']);
      		BP.del('0.1',2);
      		console.log('删除0.1下的2之后:',barragesPool['0.1']['total']);
      		console.log('当前的弹幕总数量为:',barragesPool['total']);

      		var media=document.getElementById("video-main");
      		var duration=media.duration;
      		var startTime=media.startTime;
      		var currentTime;
      		var timeRemaining;

      		console.log(duration);

      		function displayBarrage(startX,startY,endX){
   				var top=(startX=='')?'100':startX;
   				var left=(startY=='')?'820':startY;

   				console.log(top);

   				$('.barrage').css('left',left).css('top',top);
   				$('.barrage').animate({
           			left:endX+'px'
           		},5500,function(){
           			$(this).hide();
           		});
   			}

   			function getEndX(id){
				//弹幕x轴
           		var itemLeft=$('#'+id).css('left').split('px')[0];
           		//video的宽度,这里不使用硬编码是为了日后方便
           		var videoWidth=$('.container').css('width').split('px')[0];
           		//字符串的长度
           		var charWidth=$('#'+id).css('width').split('px')[0];
           		//结束X坐标是视频宽度-弹幕X轴-字符串长度
           		var endPos=videoWidth-itemLeft-charWidth;
           		return endPos;
   			}

      		var eventListener=function(e){
       			media.addEventListener(e,function(){
           			switch(e){
           				case 'play':
           				  	var endPos=getEndX('hhh1');

           					//字符串高度
           					var charHeight=$('.barrage').css('fontSize').split('px')[0];
           					console.log(endPos);
           					//displayBarrage('500','500',endPos);
           					break;
           				case 'pause':
           					console.log('dsds');
           					$(".barrage").stop();
           					break;
           				default:
           					break;
           			}
       			});
   			}

   			//监视现在播放进度和剩余时间
			media.addEventListener("timeupdate",function(){ 
  				var vTime=media.currentTime;
  				currentTime=vTime.toFixed(1);
  				timeRemaining=(duration-vTime).toFixed(1);

  				var endPos=getEndX('hhh1');
  				displayBarrage('500','500',endPos);

  				console.log(currentTime,timeRemaining);
			}, false);

      		eventListener('play');
      		eventListener('pause');
      		//eventListener('timeupdate');
      		eventListener('ended');
      		
		});
	</script>
</body>
</html>